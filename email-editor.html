<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Email Template Editor - Codegrin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --max-width:1200px; --pad:18px; --accent:#0b6efe; }
    * { box-sizing: border-box; }
    body { font-family: Inter, Arial, sans-serif; margin:0; padding:20px; background:#f7f9fc; color:#111; }
    .container { max-width: var(--max-width); margin:24px auto; background:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(12,20,40,0.06); padding:24px; }
    h1 { margin:0 0 8px 0; font-size:20px; color:var(--accent); }
    h2 { margin:20px 0 12px 0; font-size:16px; color:#334; border-bottom:2px solid #e3e7ee; padding-bottom:6px; }
    p.lead { margin:0 0 18px 0; color:#556; font-size:14px; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
    .btn { background:var(--accent); color:#fff; padding:10px 16px; border-radius:8px; border:none; cursor:pointer; font-weight:600; font-size:14px; transition:background 0.2s; }
    .btn:hover { background:#0956d1; }
    .btn.secondary { background:#eef3ff; color:var(--accent); }
    .btn.secondary:hover { background:#dce8ff; }
    .btn.danger { background:#dc3545; }
    .btn.danger:hover { background:#bb2d3b; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }
    label { display:block; font-size:13px; color:#334; margin-bottom:6px; font-weight:600; }
    input[type="text"], textarea { width:100%; padding:10px 12px; border:1px solid #e3e7ee; border-radius:8px; font-size:14px; background:#fff; }
    textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; resize:vertical; }
    .form-group { margin-bottom:16px; }
    .editor-layout { display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px; }
    .editor-panel { border:1px solid #e3e7ee; border-radius:8px; padding:16px; background:#fafbfc; }
    .preview-panel { border:1px solid #e3e7ee; border-radius:8px; padding:16px; background:#fff; overflow:auto; max-height:600px; }
    .preview-content { border:1px solid #dee2e6; padding:20px; background:#fff; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .toolbar button { padding:6px 12px; font-size:12px; }
    .placeholder-tag { display:inline-block; background:#e3f2fd; color:#1976d2; padding:2px 6px; border-radius:4px; font-family: monospace; font-size:12px; margin:0 2px; }
    .template-list { display:grid; gap:10px; margin-top:12px; }
    .template-item { display:flex; justify-content:space-between; align-items:center; padding:12px; border:1px solid #e3e7ee; border-radius:6px; background:#fff; }
    .template-item:hover { background:#f8f9fa; }
    .template-name { font-weight:600; color:#334; }
    .template-subject { font-size:12px; color:#667; margin-top:2px; }
    .template-actions { display:flex; gap:6px; }
    .template-actions button { padding:6px 10px; font-size:12px; }
    .alert { padding:12px; border-radius:6px; margin-bottom:16px; font-size:14px; }
    .alert-info { background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb; }
    .alert-warning { background:#fff3cd; color:#856404; border:1px solid #ffeaa7; }
    .alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .placeholder-info { background:#f8f9fa; padding:12px; border-radius:6px; margin-bottom:12px; font-size:12px; color:#556; }
    .placeholder-info code { background:#e3e7ee; padding:2px 6px; border-radius:3px; font-family:monospace; }
    .hidden { display:none; }
    .tabs { display:flex; gap:4px; margin-bottom:16px; border-bottom:2px solid #e3e7ee; }
    .tab { padding:10px 16px; cursor:pointer; border:none; background:none; color:#667; font-weight:600; border-bottom:2px solid transparent; margin-bottom:-2px; }
    .tab.active { color:var(--accent); border-bottom-color:var(--accent); }
    .tab:hover { color:#334; }
    .top-actions { display:flex; gap:8px; }
    footer { margin-top:18px; font-size:12px; color:#889; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>Email Template Editor</h1>
        <p class="lead">Create and manage custom email templates with live preview</p>
      </div>
      <div class="top-actions">
        <button id="backBtn" class="btn secondary">Back to Mail Sender</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="editor">Template Editor</button>
      <button class="tab" data-tab="templates">Saved Templates (0/5)</button>
    </div>

    <div id="editorTab" class="tab-content">
      <div class="alert alert-info">
        Use placeholders like <code>{{username}}</code>, <code>{{date}}</code>, or <code>{{company}}</code> in your template. These will be replaced when sending emails.
      </div>

      <div class="form-group">
        <label for="templateName">Template Name</label>
        <input id="templateName" type="text" placeholder="My Custom Template" />
      </div>

      <div class="form-group">
        <label for="emailSubject">Email Subject</label>
        <input id="emailSubject" type="text" placeholder="Enter email subject" value="Proposal for Development Partnership â€“ Codegrin Technologies" />
      </div>

      <div class="editor-layout">
        <div class="editor-panel">
          <h2>HTML Editor</h2>

          <div class="placeholder-info">
            Available placeholders: <code>{{username}}</code> <code>{{email}}</code> <code>{{date}}</code> <code>{{company}}</code> <code>{{customField1}}</code> <code>{{customField2}}</code>
          </div>

          <div class="toolbar">
            <button class="btn secondary" data-insert="<strong>Bold Text</strong>">Bold</button>
            <button class="btn secondary" data-insert="<em>Italic Text</em>">Italic</button>
            <button class="btn secondary" data-insert="<h2>Heading</h2>">Heading</button>
            <button class="btn secondary" data-insert="<a href='https://example.com'>Link</a>">Link</button>
            <button class="btn secondary" data-insert="<ul><li>Item 1</li><li>Item 2</li></ul>">List</button>
            <button class="btn secondary" data-insert="{{username}}">{{username}}</button>
            <button class="btn secondary" data-insert="{{date}}">{{date}}</button>
            <button class="btn secondary" data-insert="{{company}}">{{company}}</button>
          </div>

          <textarea id="htmlEditor" rows="20" placeholder="Enter your HTML content here..."></textarea>

          <div style="margin-top:12px; display:flex; gap:8px;">
            <button id="previewBtn" class="btn">Update Preview</button>
            <button id="saveTemplateBtn" class="btn secondary">Save Template</button>
            <button id="clearEditorBtn" class="btn secondary">Clear</button>
          </div>
        </div>

        <div class="preview-panel">
          <h2>Live Preview</h2>
          <div class="preview-content" id="previewContent">
            <p style="color:#888;">Your email preview will appear here...</p>
          </div>
        </div>
      </div>
    </div>

    <div id="templatesTab" class="tab-content hidden">
      <div class="alert alert-warning" id="templateLimitWarning" style="display:none;">
        You've reached the maximum of 5 saved templates. Delete one to save a new template.
      </div>

      <div class="template-list" id="templateList">
        <p style="color:#888; text-align:center; padding:40px;">No saved templates yet. Create one in the editor!</p>
      </div>
    </div>

    <footer>
      <div>Templates are stored locally in your browser. Maximum 5 templates per user.</div>
    </footer>
  </div>

  <script>
    const MAX_TEMPLATES = 5;
    const STORAGE_KEY = 'cg_email_templates';

    const tabButtons = document.querySelectorAll('.tab');
    const editorTab = document.getElementById('editorTab');
    const templatesTab = document.getElementById('templatesTab');
    const templateName = document.getElementById('templateName');
    const emailSubject = document.getElementById('emailSubject');
    const htmlEditor = document.getElementById('htmlEditor');
    const previewContent = document.getElementById('previewContent');
    const templateList = document.getElementById('templateList');
    const templateLimitWarning = document.getElementById('templateLimitWarning');
    const backBtn = document.getElementById('backBtn');

    const defaultTemplate = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            line-height: 1.6;
            color: #333333;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
        }
        .header {
            background-color: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #007bff;
            margin-bottom: 30px;
        }
        h1 {
            color: #007bff;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .content {
            padding: 0 20px;
        }
        .footer {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Welcome {{username}}!</h1>
        <p><strong>{{company}}</strong></p>
    </div>

    <div class="content">
        <p>Hello {{username}},</p>

        <p>This is a sample email template sent on {{date}}.</p>

        <p>You can customize this template with your own content, styling, and placeholders.</p>

        <p>Best regards,<br>
        Your Team</p>
    </div>

    <div class="footer">
        <p>This email was sent to {{email}}</p>
    </div>
</body>
</html>`;

    htmlEditor.value = defaultTemplate;

    function getTemplates() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
      } catch (e) {
        console.error('Failed to load templates:', e);
        return [];
      }
    }

    function saveTemplates(templates) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(templates));
        return true;
      } catch (e) {
        alert('Failed to save template: ' + e.message);
        return false;
      }
    }

    function updateTemplateCount() {
      const templates = getTemplates();
      const tab = document.querySelector('[data-tab="templates"]');
      tab.textContent = `Saved Templates (${templates.length}/${MAX_TEMPLATES})`;
      templateLimitWarning.style.display = templates.length >= MAX_TEMPLATES ? 'block' : 'none';
    }

    function renderTemplateList() {
      const templates = getTemplates();

      if (templates.length === 0) {
        templateList.innerHTML = '<p style="color:#888; text-align:center; padding:40px;">No saved templates yet. Create one in the editor!</p>';
        return;
      }

      templateList.innerHTML = templates.map((tpl, idx) => `
        <div class="template-item">
          <div>
            <div class="template-name">${escapeHtml(tpl.name)}</div>
            <div class="template-subject">${escapeHtml(tpl.subject)}</div>
          </div>
          <div class="template-actions">
            <button class="btn secondary" onclick="loadTemplate(${idx})">Load</button>
            <button class="btn secondary" onclick="useTemplate(${idx})">Use</button>
            <button class="btn danger" onclick="deleteTemplate(${idx})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function replacePlaceholders(html, data) {
      let result = html;
      for (const [key, value] of Object.entries(data)) {
        const regex = new RegExp(`{{${key}}}`, 'g');
        result = result.replace(regex, value);
      }
      return result;
    }

    function updatePreview() {
      const html = htmlEditor.value;
      const sampleData = {
        username: 'John Doe',
        email: 'john@example.com',
        date: new Date().toLocaleDateString(),
        company: 'Codegrin Technologies',
        customField1: 'Sample Value 1',
        customField2: 'Sample Value 2'
      };

      const rendered = replacePlaceholders(html, sampleData);
      previewContent.innerHTML = rendered;
    }

    window.loadTemplate = function(idx) {
      const templates = getTemplates();
      if (templates[idx]) {
        const tpl = templates[idx];
        templateName.value = tpl.name;
        emailSubject.value = tpl.subject;
        htmlEditor.value = tpl.html;
        updatePreview();

        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabButtons[0].classList.add('active');
        editorTab.classList.remove('hidden');
        templatesTab.classList.add('hidden');
      }
    };

    window.useTemplate = function(idx) {
      const templates = getTemplates();
      if (templates[idx]) {
        const tpl = templates[idx];
        sessionStorage.setItem('cg_selected_template', JSON.stringify(tpl));
        window.location.href = '/';
      }
    };

    window.deleteTemplate = function(idx) {
      if (!confirm('Are you sure you want to delete this template?')) return;

      const templates = getTemplates();
      templates.splice(idx, 1);
      saveTemplates(templates);
      renderTemplateList();
      updateTemplateCount();
    };

    document.getElementById('previewBtn').addEventListener('click', updatePreview);

    document.getElementById('saveTemplateBtn').addEventListener('click', () => {
      const templates = getTemplates();

      if (templates.length >= MAX_TEMPLATES) {
        alert(`Maximum of ${MAX_TEMPLATES} templates reached. Please delete one before saving a new template.`);
        return;
      }

      const name = templateName.value.trim();
      const subject = emailSubject.value.trim();
      const html = htmlEditor.value.trim();

      if (!name) {
        alert('Please enter a template name.');
        return;
      }

      if (!subject) {
        alert('Please enter an email subject.');
        return;
      }

      if (!html) {
        alert('Please enter HTML content.');
        return;
      }

      const existingIdx = templates.findIndex(t => t.name === name);
      if (existingIdx >= 0) {
        if (!confirm('A template with this name already exists. Overwrite it?')) return;
        templates[existingIdx] = { name, subject, html, updatedAt: Date.now() };
      } else {
        templates.push({ name, subject, html, createdAt: Date.now(), updatedAt: Date.now() });
      }

      if (saveTemplates(templates)) {
        alert('Template saved successfully!');
        renderTemplateList();
        updateTemplateCount();
      }
    });

    document.getElementById('clearEditorBtn').addEventListener('click', () => {
      if (confirm('Clear the editor? This will not delete saved templates.')) {
        templateName.value = '';
        emailSubject.value = '';
        htmlEditor.value = defaultTemplate;
        updatePreview();
      }
    });

    document.querySelectorAll('.toolbar button[data-insert]').forEach(btn => {
      btn.addEventListener('click', () => {
        const insert = btn.getAttribute('data-insert');
        const start = htmlEditor.selectionStart;
        const end = htmlEditor.selectionEnd;
        const text = htmlEditor.value;
        htmlEditor.value = text.substring(0, start) + insert + text.substring(end);
        htmlEditor.focus();
        htmlEditor.selectionStart = htmlEditor.selectionEnd = start + insert.length;
      });
    });

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-tab');

        tabButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        if (tab === 'editor') {
          editorTab.classList.remove('hidden');
          templatesTab.classList.add('hidden');
        } else if (tab === 'templates') {
          editorTab.classList.add('hidden');
          templatesTab.classList.remove('hidden');
          renderTemplateList();
        }
      });
    });

    backBtn.addEventListener('click', () => {
      window.location.href = '/';
    });

    updatePreview();
    updateTemplateCount();
  </script>
</body>
</html>
